<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>EV MAXIMIZER - Elite GTO System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --bg: #000; --panel: #0a0a0a; --accent: #00ff87; --text: #e0e0e0; --border: #1a1a1a; --blue: #00d4ff; --nash: #ff4444; }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* --- STILI LOGIN E DASHBOARD --- */
        .glass-card { background: rgba(23, 32, 51, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); border-radius: 24px; }
        .gradient-text { background: linear-gradient(90deg, #00ff87, #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- SIDEBAR SINISTRA --- */
        #sidebar-left { width: 280px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
        .sidebar-brand-container { padding: 25px 15px; text-align: center; }
        .brand-logo-main { width: 100%; max-width: 170px; filter: drop-shadow(0 0 10px var(--accent)); }
        .nav-group { padding: 10px 15px; }
        .cat-label { font-size: 0.65rem; text-transform: uppercase; margin: 20px 0 8px; display: block; font-weight: 800; letter-spacing: 1.5px; color: var(--accent); opacity: 0.8; }
        .nav-btn { width: 100%; padding: 10px; margin-bottom: 4px; background: #0d0d0d; border: 1px solid #222; color: #777; text-align: left; cursor: pointer; border-radius: 6px; font-size: 0.75rem; transition: 0.2s; font-weight: 500; }
        .nav-btn:hover, .nav-btn.active { background: var(--accent); color: #000; font-weight: bold; border-color: var(--accent); }

        /* --- AREA PRINCIPALE --- */
        #main-view { flex-grow: 1; display: flex; flex-direction: column; background: #000; overflow: hidden; }
        #header-tech { height: 70px; background: #0a0a0a; display: flex; align-items: center; justify-content: center; gap: 30px; border-bottom: 1px solid var(--border); flex-shrink: 0; padding: 0 20px; }
        #rng-box { font-family: 'Monaco', monospace; font-size: 2.2rem; color: var(--accent); background: #000; border: 1px solid var(--accent); padding: 5px 20px; border-radius: 6px; min-width: 80px; text-align: center; }
        
        /* --- WORKSPACE --- */
        #workspace { display: flex; flex-grow: 1; overflow: hidden; }
        #stack-bar { width: 110px; background: #050505; display: flex; flex-direction: column; gap: 8px; padding: 15px 10px; overflow-y: auto; border-right: 1px solid var(--border); }
        .stk-btn { width: 100%; padding: 12px 5px; background: #111; border: 1px solid #333; color: #fff; border-radius: 5px; cursor: pointer; font-size: 0.75rem; font-weight: bold; text-align: center; }
        .stk-btn.active { background: var(--blue); color: #000; border-color: var(--blue); }
        #image-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; padding: 20px; }
        #current-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; z-index: 5; }

        /* --- SIDEBAR DESTRA --- */
        #sidebar-right { width: 360px; background: var(--panel); border-left: 1px solid var(--border); padding: 15px; overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; }
        .section-box { background: #050505; border: 1px solid #1a1a1a; border-radius: 8px; padding: 12px; border-top: 3px solid var(--accent); }
        .section-title { color: var(--blue); font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 10px; display: block; border-bottom: 1px solid #222; padding-bottom: 5px; }
        
        /* --- TIMER E SALDO --- */
        #session-timer { color: #00ff87; font-family: monospace; font-size: 1.5rem; margin-left: 20px; background: #000; padding: 5px 10px; border-radius: 5px; border: 1px solid #222; }
        .balance-display { background: linear-gradient(135deg, #0a0a0a, #111); border: 1px solid var(--blue); padding: 8px 15px; border-radius: 12px; text-align: center; min-width: 130px; }
        
        /* --- TABELLA TAVOLI --- */
        .table-container { background: #050505; border-radius: 8px; padding: 10px; border: 1px solid #1a1a1a; max-height: 250px; overflow-y: auto; }
        table { width: 100%; font-size: 0.65rem; border-collapse: collapse; }
        th { color: #64748b; text-transform: uppercase; padding: 6px; text-align: left; border-bottom: 1px solid #1e293b; }
        .profit-pill { padding: 2px 6px; border-radius: 4px; font-weight: 900; }
        .pos { background: rgba(0, 255, 135, 0.15); color: #00ff87; }
        .neg { background: rgba(255, 68, 68, 0.15); color: #ff4444; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="authBox" class="glass-card p-10 w-full max-w-md mx-auto my-auto shadow-2xl">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-black tracking-tighter gradient-text uppercase">EV Maximizer</h1>
            <p class="text-slate-500 text-[10px] mt-2 font-bold tracking-widest uppercase">Premium Strategy Suite</p>
        </div>
        <div class="space-y-4">
            <input type="text" id="userId" placeholder="Username" class="w-full px-4 py-4 rounded-xl outline-none bg-slate-900 border border-slate-800 text-white focus:border-[#00ff87] transition-all">
            <input type="password" id="userPass" placeholder="Password" class="w-full px-4 py-4 rounded-xl outline-none bg-slate-900 border border-slate-800 text-white focus:border-[#00ff87] transition-all">
            <button onclick="handleLogin()" class="w-full bg-[#00ff87] text-black font-black py-4 rounded-xl uppercase hover:scale-[1.02] transition-transform shadow-lg shadow-[#00ff87]/20">Accedi al Sistema</button>
        </div>
        <p id="msg" class="mt-6 text-center text-sm font-bold text-yellow-500"></p>
    </div>

    <div id="dashboard" class="hidden w-full max-w-5xl mx-auto p-6 overflow-y-auto">
        <header class="flex justify-between items-center mb-10 bg-slate-900/50 p-6 rounded-3xl border border-white/5">
            <h2 class="text-2xl font-black italic">DASHBOARD <span class="text-[#00ff87]">PRO</span></h2>
            <div class="flex items-center gap-4">
                <span id="user-display" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Operator: Active</span>
                <button onclick="logout()" class="text-red-500 font-bold text-xs bg-red-500/10 px-4 py-2 rounded-lg hover:bg-red-500/20 transition-colors">LOGOUT</button>
            </div>
        </header>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <div class="glass-card p-6 border border-blue-500/20">
                <p class="text-blue-400 text-[10px] font-bold uppercase mb-4">Cassa Iniziale Sessione</p>
                <div class="flex gap-2">
                    <input type="number" id="initialBalance" placeholder="Esempio: 500" class="flex-grow bg-black border border-slate-800 p-4 rounded-xl text-white font-mono text-xl outline-none focus:border-blue-500">
                    <button onclick="saveBalance()" class="bg-blue-600 text-white px-6 rounded-xl font-bold uppercase text-xs hover:bg-blue-500">Salva</button>
                </div>
            </div>

            <div class="glass-card p-6 border border-green-500/20 flex items-center justify-between">
                <div>
                    <p class="text-green-500 text-[10px] font-bold uppercase mb-1">Stato Sincronizzazione</p>
                    <h3 class="text-xl font-black text-white uppercase">Cloud Link Active</h3>
                </div>
                <div class="relative">
                    <i class="fa-solid fa-circle-check text-[#00ff87] text-4xl animate-pulse"></i>
                </div>
            </div>
        </div>

        <div class="glass-card p-12 text-center bg-gradient-to-br from-slate-800/30 to-transparent border-2 border-[#00ff87]/20">
            <i class="fa-solid fa-rocket text-5xl text-[#00ff87] mb-6"></i>
            <h3 class="text-3xl font-black mb-4 uppercase">Strategia Caricata</h3>
            <p class="text-slate-400 mb-8 max-w-md mx-auto text-sm">Il sistema è pronto per l'analisi real-time dei range GTO e la gestione del bankroll dinamico.</p>
            <button onclick="showTech()" class="bg-[#00ff87] text-black px-12 py-5 rounded-2xl font-black text-xl shadow-lg shadow-[#00ff87]/20 hover:scale-105 transition-all uppercase">Lancia Interfaccia Analisi</button>
        </div>
    </div>

    <div id="techInterface" class="hidden w-full h-screen flex">
        <aside id="sidebar-left">
            <div class="sidebar-brand-container">
                <button onclick="showDash()" class="text-[10px] text-slate-500 mb-4 block hover:text-[#00ff87] uppercase font-bold"><i class="fa-solid fa-arrow-left"></i> Dashboard</button>
                <img src="logo_maximizer.webp" class="brand-logo-main" alt="Logo">
            </div>

            <div class="nav-group">
                <span class="cat-label">3-Way Strategy</span>
                <button class="nav-btn active" onclick="sm('1. BTN Open', 'btnopen_', this)">1. BTN Open</button>
                <button class="nav-btn" onclick="sm('2. SB vs BTN', 'sbvsbtn_', this)">2. SB vs BTN</button>
                <button class="nav-btn" onclick="sm('3. SB vs BB', 'sbvsbb_', this)">3. SB vs BB</button>
                <button class="nav-btn" onclick="sm('4. SB vs BTN Limp', 'sbvslimp_', this)">4. SB vs BTN Limp</button>
                <button class="nav-btn" onclick="sm('5. BB vs BTN', 'bbvbt_', this)">5. BB vs BTN</button>
                <button class="nav-btn" onclick="sm('6. BB vs SB', 'bbvssb_', this)">6. BB vs SB</button>
                <button class="nav-btn" onclick="sm('7. BB vs SB Limp', 'bbvssblimp_', this)">7. BB vs SB Limp</button>
                <button class="nav-btn" onclick="sm('8. BB vs BTN Iso', 'bbvsbtniso_', this)">8. BB vs BTN Iso</button>
                <button class="nav-btn" onclick="sm('9. BB vs SB Iso', 'bbvssbiso_', this)">9. BB vs SB Iso</button>
                <button class="nav-btn" onclick="sm('10. BB vs 2 PL', 'bbvs2pl_', this)">10. BB vs 2 PL</button>

                <span class="cat-label">Heads-Up Strategy</span>
                <button class="nav-btn" onclick="sm('11. HU IP Open', 'huip_', this)">11. HU IP Open</button>
                <button class="nav-btn" onclick="sm('12. HU OOP vs Limp', 'huooplimp_', this)">12. HU OOP vs Limp</button>
                <button class="nav-btn" onclick="sm('13. HU OOP vs MR', 'huoopmr_', this)">13. HU OOP vs MR</button>
                <button class="nav-btn" onclick="sm('14. HU OOP vs Shove', 'huoopshove_', this)">14. HU OOP vs Shove</button>
            </div>
        </aside>

        <main id="main-view">
            <header id="header-tech">
                <div id="rng-box">--</div>
                <button onclick="roll()" class="bg-[#00ff87] text-black font-black px-12 h-[45px] rounded-md uppercase text-xs tracking-tighter hover:bg-[#00d16d] transition-colors">ROLL RNG</button>
                
                <div id="session-timer">00:00:00</div>

                <div class="balance-display">
                    <p class="text-[0.55rem] text-blue-400 font-bold uppercase tracking-widest">Saldo Real-Time (Mese)</p>
                    <h2 id="live-balance" class="text-xl font-black text-white">€ 0.00</h2>
                </div>
            </header>
            
            <div id="workspace">
                <div id="stack-bar">
                    </div>
                <div id="image-area">
                    <img id="current-img" src="" alt="Range">
                </div>
                
                <aside id="sidebar-right">
                    <div class="section-box">
                        <span class="section-title">GTO Advisor Elite</span>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="bg-[#151515] text-white p-2 text-[0.6rem] font-bold uppercase border border-slate-800 hover:border-blue-500" onclick="advise('IP_AGG')">IP Aggressore</button>
                            <button class="bg-[#151515] text-white p-2 text-[0.6rem] font-bold uppercase border border-slate-800 hover:border-blue-500" onclick="advise('IP_VS_AGG')">IP vs Aggr.</button>
                            <button class="bg-[#151515] text-white p-2 text-[0.6rem] font-bold uppercase border border-slate-800 hover:border-blue-500" onclick="advise('OOP_AGG')">OOP Aggressore</button>
                            <button class="bg-[#151515] text-white p-2 text-[0.6rem] font-bold uppercase border border-slate-800 hover:border-blue-500" onclick="advise('OOP_VS_AGG')">OOP vs Aggr.</button>
                        </div>
                        <div id="gto-solution-box" class="mt-2 p-2 bg-black min-h-[60px] border border-[#00ff87]/30 text-[0.6rem] text-slate-400 leading-relaxed italic">
                            Seleziona una situazione post-flop per ricevere il suggerimento strategico basato sulle frequenze ottimali.
                        </div>
                    </div>

                    <div class="section-box !border-t-red-500">
                        <span class="section-title !color-red-500" style="color: #ff4444;">Nash Equilibrium</span>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="bg-red-950/30 text-red-500 border border-red-500 p-3 font-black text-xs hover:bg-red-500 hover:text-white transition-all" onclick="sm('Nash Call', 'nashcall_', this)">CALL</button>
                            <button class="bg-yellow-950/30 text-yellow-500 border border-yellow-500 p-3 font-black text-xs hover:bg-yellow-500 hover:text-white transition-all" onclick="sm('Nash Push', 'nashpush_', this)">PUSH</button>
                        </div>
                    </div>

                    <div class="section-box">
                        <span class="section-title">Sincronizzatore Tavoli</span>
                        <label class="block border border-dashed border-[#00ff87] p-4 text-center cursor-pointer hover:bg-[#00ff87]/10 transition-colors">
                            <i class="fa-solid fa-folder-open text-[#00ff87] text-xl mb-1"></i>
                            <p class="text-[0.5rem] uppercase text-slate-500 font-bold">Carica Cartella Range WebP</p>
                            <input type="file" id="file-input" webkitdirectory directory multiple class="hidden">
                        </label>
                    </div>

                    <div class="table-container">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[0.6rem] font-bold text-slate-500 uppercase tracking-widest">Tavoli Attivi / Mani</p>
                            <i class="fa-solid fa-arrows-rotate text-[#00ff87] text-[10px] animate-spin"></i>
                        </div>
                        <table id="mani-recenti-table">
                            <thead>
                                <tr>
                                    <th>ORA</th>
                                    <th>PROFIT</th>
                                    <th>BUY-IN</th>
                                </tr>
                            </thead>
                            <tbody class="text-white">
                                </tbody>
                        </table>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzD0AT0NeqPsSJkTYxCtuKHABBnUbNaUlvRAY--fRrQDKNPE568B3EIRj65o4AFoc2ePA/exec";
        
        let persistentFiles = []; 
        let currentKey = "btnopen_";
        let startingBankroll = parseFloat(localStorage.getItem('bankroll')) || 0;

        function saveBalance() {
            const val = document.getElementById('initialBalance').value;
            startingBankroll = parseFloat(val) || 0;
            localStorage.setItem('bankroll', startingBankroll);
            alert("Saldo Iniziale Salvato: €" + startingBankroll);
            refreshLiveStats();
        }

        async function handleLogin() {
            const u = document.getElementById('userId').value.trim();
            const p = document.getElementById('userPass').value.trim();
            if(!u || !p) return;

            document.getElementById('msg').innerText = "VERIFICA CREDENZIALI...";

            try {
                const response = await fetch(`${SCRIPT_URL}?id=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}&action=login`);
                const result = await response.text();

                if(result.toUpperCase().includes("SUCCESS")) {
                    localStorage.setItem('ev_logged', 'true');
                    showDash();
                } else {
                    document.getElementById('msg').innerText = "ACCESSO NEGATO";
                }
            } catch(e) {
                document.getElementById('msg').innerText = "ERRORE DI CONNESSIONE";
            }
        }

        function showDash() {
            document.getElementById('authBox').classList.add('hidden');
            document.getElementById('techInterface').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.body.className = "flex items-center justify-center min-h-screen";
            document.getElementById('initialBalance').value = startingBankroll;
            refreshLiveStats();
        }

        function showTech() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('techInterface').classList.remove('hidden');
            document.body.className = ""; 
        }

        function logout() {
            localStorage.removeItem('ev_logged');
            location.reload();
        }

        function roll() {
            document.getElementById('rng-box').innerText = Math.floor(Math.random() * 101);
        }

        document.getElementById('file-input').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            persistentFiles = files.filter(f => f.name.toLowerCase().endsWith('.webp'));
            render();
        });

        function sm(name, key, btn) {
            currentKey = key;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn && btn.classList.contains('nav-btn')) btn.classList.add('active');
            render();
        }

        function render() {
            const bar = document.getElementById('stack-bar');
            const img = document.getElementById('current-img');
            bar.innerHTML = '';

            if (persistentFiles.length === 0) return;

            const filtered = persistentFiles.filter(f => f.name.toLowerCase().startsWith(currentKey.toLowerCase()));

            if (filtered.length > 0) {
                img.style.display = 'block';
                filtered.sort((a,b) => {
                    const numA = parseInt(a.name.match(/\d+/)) || 0;
                    const numB = parseInt(b.name.match(/\d+/)) || 0;
                    return numA - numB;
                });

                filtered.forEach((f, i) => {
                    const b = document.createElement('button');
                    b.className = 'stk-btn';
                    const label = f.name.split('_')[1]?.replace('.webp', '').toUpperCase() || "RG";
                    b.innerText = label;
                    
                    b.onclick = () => {
                        const r = new FileReader();
                        r.onload = (e) => { 
                            img.src = e.target.result; 
                        };
                        r.readAsDataURL(f);
                        document.querySelectorAll('.stk-btn').forEach(x => x.classList.remove('active'));
                        b.classList.add('active');
                    };
                    bar.appendChild(b);
                    if(i === 0) b.click();
                });
            } else {
                img.style.display = 'none';
            }
        }

        function advise(type) {
            const box = document.getElementById('gto-solution-box');
            const data = {
                'IP_AGG': 'Flop Dry: Bet 33% | Flop Wet: Check o Bet 75%. Su Turn Blank continuare con 66%.',
                'IP_VS_AGG': 'Value: Raise 3x o Call | Draw: Pure Call se le odds sono favorevoli. Fold su Overbet.',
                'OOP_AGG': 'OOP: Check-Raise frequency 18%. Su Board connessi favorire il Check-Fold con air.',
                'OOP_VS_AGG': 'Pure Call con Mid Pair o Flush Draw. Donk Bet sconsigliata nel 95% dei casi.'
            };
            box.innerText = data[type] || "Seleziona...";
        }

        // --- SISTEMA DI SINCRONIZZAZIONE AGGIORNATO (MENSILE) ---
        async function refreshLiveStats() {
            try {
                const response = await fetch(SCRIPT_URL);
                const sessions = await response.json();
                const tbody = document.querySelector("#mani-recenti-table tbody");
                if (!tbody) return;
                
                tbody.innerHTML = "";
                const currentMonth = new Date().getMonth() + 1;
                let monthlyProfit = 0;

                // Calcolo profitto filtrato per mese corrente
                sessions.forEach(s => {
                    const sDate = new Date(s.data);
                    if((sDate.getMonth() + 1) === currentMonth) {
                        monthlyProfit += parseFloat(s.profit);
                    }
                });

                // Visualizza le sessioni invertite
                sessions.slice().reverse().forEach((s, index) => {
                    const dateObj = new Date(s.data);
                    const timeStr = isNaN(dateObj) ? "--:--" : dateObj.getHours() + ":" + String(dateObj.getMinutes()).padStart(2, '0');
                    
                    const profitVal = parseFloat(s.profit);
                    const colorClass = profitVal < 0 ? "neg" : "pos";
                    
                    tbody.innerHTML += `
                        <tr class="border-b border-white/5">
                            <td class="py-2 text-slate-500 font-mono">${timeStr}</td>
                            <td class="py-2"><span class="profit-pill ${colorClass}">${profitVal >= 0 ? '+' : ''}${profitVal.toFixed(2)}€</span></td>
                            <td class="py-2 text-slate-300 font-mono">${s.buyin}€</td>
                        </tr>`;
                    
                    // Sincronizza Timer dall'ultima riga
                    if(index === 0 && s.durata) {
                        const timerDisplay = document.getElementById('session-timer');
                        if(timerDisplay) timerDisplay.innerText = s.durata;
                    }
                });

                // Aggiornamento Saldo: Cassa Iniziale + Solo Profitto del Mese
                updateLiveBalance(monthlyProfit);

            } catch (e) { console.error("Sync Error"); }
        }

        function updateLiveBalance(profit) {
            const current = startingBankroll + profit;
            const el = document.getElementById('live-balance');
            if(el) {
                el.innerText = "€ " + current.toFixed(2);
                el.style.color = current >= startingBankroll ? "#00ff87" : "#ff4444";
            }
        }

        if (localStorage.getItem('ev_logged') === 'true') showDash();
        setInterval(refreshLiveStats, 10000);

    </script>
</body>
</html>