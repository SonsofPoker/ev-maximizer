<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>EV MAXIMIZER - Elite GTO System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --bg: #000; --panel: #0a0a0a; --accent: #00ff87; --text: #e0e0e0; --border: #1a1a1a; --blue: #00d4ff; --nash: #ff4444; }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* --- STILI ORIGINALI RIPRISTINATI --- */
        .glass-card { background: rgba(23, 32, 51, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); border-radius: 24px; }
        .sidebar { width: 280px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 30px 20px; }
        .main-content { flex: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top right, #0a1510, #000); }
        
        .stat-card { background: #0a0a0a; border: 1px solid var(--border); padding: 25px; border-radius: 20px; transition: all 0.3s; position: relative; overflow: hidden; }
        .stat-card:hover { border-color: var(--accent); transform: translateY(-5px); }
        
        .profit-pill { padding: 4px 12px; border-radius: 99px; font-weight: bold; font-size: 0.85rem; }
        .profit-pill.pos { background: rgba(0, 255, 135, 0.1); color: var(--accent); }
        .profit-pill.neg { background: rgba(255, 68, 68, 0.1); color: var(--nash); }

        input { background: #111 !important; border: 1px solid #222 !important; color: white !important; }
        .btn-primary { background: var(--accent); color: black; font-weight: 900; transition: all 0.3s; }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black px-4">
        <div class="glass-card w-full max-w-md p-10 text-center">
            <div class="mb-8">
                <h1 class="text-4xl font-black tracking-tighter text-[#00ff87]">EV MAXIMIZER</h1>
                <p class="text-xs font-bold text-gray-500 tracking-[0.3em] uppercase">Elite Tracker System</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="user" placeholder="Username" class="w-full p-4 rounded-xl outline-none focus:border-[#00ff87]">
                <input type="password" id="pass" placeholder="Password" class="w-full p-4 rounded-xl outline-none focus:border-[#00ff87]">
                <button onclick="login()" class="btn-primary w-full p-4 rounded-xl shadow-lg shadow-[#00ff87]/20">ENTRA NEL SISTEMA</button>
            </div>
            <p id="login-err" class="mt-4 text-red-500 text-sm font-bold"></p>
        </div>
    </div>

    <div id="dashboard" class="hidden flex w-full h-full">
        <aside class="sidebar">
            <div class="mb-12">
                <h2 class="text-2xl font-black text-[#00ff87] italic">EV<span class="text-white">MAX</span></h2>
            </div>
            <nav class="space-y-2 flex-1">
                <a href="#" class="flex items-center gap-4 p-4 bg-[#00ff87]/10 text-[#00ff87] rounded-xl font-bold">
                    <i class="fas fa-chart-line w-5"></i> Dashboard
                </a>
                <a href="#" class="flex items-center gap-4 p-4 text-gray-500 hover:bg-white/5 rounded-xl transition font-medium">
                    <i class="fas fa-history w-5"></i> Sessioni
                </a>
                <a href="#" class="flex items-center gap-4 p-4 text-gray-500 hover:bg-white/5 rounded-xl transition font-medium">
                    <i class="fas fa-cog w-5"></i> Impostazioni
                </a>
            </nav>
            <button onclick="logout()" class="flex items-center gap-4 p-4 text-red-400 hover:bg-red-500/10 rounded-xl transition font-bold">
                <i class="fas fa-sign-out-alt w-5"></i> LOGOUT
            </button>
        </aside>

        <main class="main-content">
            <header class="flex justify-between items-end mb-12">
                <div>
                    <h1 class="text-4xl font-black italic tracking-tight">DASHBOARD <span class="text-[#00ff87]">LIVE</span></h1>
                    <p class="text-gray-500 font-medium">Benvenuto nel terminale di controllo GTO.</p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-black text-gray-500 uppercase tracking-widest">Sincronizzazione</p>
                    <p class="text-[#00ff87] font-mono text-sm">● Cloud Link Active</p>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="stat-card">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-2">Bankroll Attuale (Mese)</p>
                    <h3 id="live-balance" class="text-4xl font-black font-mono italic">€ 0.00</h3>
                </div>
                <div class="stat-card">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-2">Timer Sessione</p>
                    <h3 id="session-timer" class="text-4xl font-black font-mono text-white">00:00:00</h3>
                </div>
                <div class="stat-card">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-2">Stato Sistema</p>
                    <h3 class="text-4xl font-black italic text-[#00ff87]">ATTIVO</h3>
                </div>
            </div>

            <div class="glass-card p-8 border border-white/5">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-xl font-black italic uppercase tracking-tighter">Ultime Mani Concluse</h3>
                    <span class="text-xs bg-white/5 px-3 py-1 rounded text-gray-400 font-bold uppercase">Real-time Feed</span>
                </div>
                <div class="overflow-x-auto">
                    <table id="mani-recenti-table" class="w-full text-left">
                        <thead>
                            <tr class="text-gray-500 text-xs uppercase tracking-widest border-b border-white/5">
                                <th class="pb-4">Orario</th>
                                <th class="pb-4">Profit/Loss</th>
                                <th class="pb-4">Buy-in</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm font-medium text-gray-300">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzD0AT0NeqPsSJkTYxCtuKHABBnUbNaUlvRAY--fRrQDKNPE568B3EIRj65o4AFoc2ePA/exec";
        
        // Carica bankroll iniziale
        let startingBankroll = parseFloat(localStorage.getItem('bankroll')) || 500.00;

        async function login() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            const err = document.getElementById('login-err');
            
            if(!u || !p) { err.innerText = "Inserisci i dati"; return; }

            err.innerText = "Verifica in corso...";
            try {
                const r = await fetch(`${SCRIPT_URL}?id=${u}&password=${p}&action=login`);
                const res = await r.text();
                if(res.includes("SUCCESS")) {
                    localStorage.setItem('ev_logged', 'true');
                    showDash();
                } else {
                    err.innerText = "Credenziali non valide.";
                }
            } catch(e) {
                err.innerText = "Errore di connessione.";
            }
        }

        function showDash() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            refreshLiveStats();
            setInterval(refreshLiveStats, 10000);
        }

        function logout() {
            localStorage.removeItem('ev_logged');
            location.reload();
        }

        // --- FUNZIONE DI SINCRONIZZAZIONE (MODIFICATA CON LOGICA MENSILE) ---
        async function refreshLiveStats() {
            try {
                const response = await fetch(SCRIPT_URL);
                const sessions = await response.json();
                const tbody = document.querySelector("#mani-recenti-table tbody");
                if (!tbody) return;

                if (!sessions || sessions.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='3' class='text-center py-4 text-gray-600'>In attesa di dati...</td></tr>";
                    document.getElementById('live-balance').innerText = "€ " + startingBankroll.toFixed(2);
                    return;
                }

                const currentMonth = new Date().getMonth() + 1;
                let monthlyProfit = 0;
                tbody.innerHTML = "";

                // 1. Filtro Mensile per il Saldo
                sessions.forEach((s) => {
                    const sessionDate = new Date(s.data);
                    if ((sessionDate.getMonth() + 1) === currentMonth) {
                        monthlyProfit += parseFloat(s.profit);
                    }
                });

                // 2. Tabella Ultime 10 Sessioni
                sessions.slice(-10).reverse().forEach((s, index) => {
                    const date = new Date(s.data);
                    const ora = isNaN(date) ? "--:--" : date.getHours() + ":" + String(date.getMinutes()).padStart(2, '0');
                    const profitVal = parseFloat(s.profit);
                    const colorClass = profitVal >= 0 ? "pos" : "neg";
                    
                    tbody.innerHTML += `
                        <tr class="border-b border-white/5">
                            <td class="py-2 text-slate-500 font-mono">${ora}</td>
                            <td class="py-2"><span class="profit-pill ${colorClass}">${profitVal >= 0 ? '+' : ''}${profitVal.toFixed(2)}€</span></td>
                            <td class="py-2 text-slate-300 font-mono">${s.buyin}€</td>
                        </tr>`;
                    
                    // 3. Sincronizzazione Timer (dall'ultima riga inviata dall'app)
                    if(index === 0 && s.durata) {
                        const timerDisplay = document.getElementById('session-timer');
                        if(timerDisplay) timerDisplay.innerText = s.durata;
                    }
                });

                // 4. Aggiornamento Cassa Live
                updateLiveBalance(monthlyProfit);

            } catch (e) { 
                console.error("Sync Error:", e); 
            }
        }

        function updateLiveBalance(profit) {
            const current = startingBankroll + profit;
            const el = document.getElementById('live-balance');
            if(el) {
                el.innerText = "€ " + current.toFixed(2);
                el.style.color = current >= startingBankroll ? "#00ff87" : "#ff4444";
            }
        }

        // Auto-Login
        if (localStorage.getItem('ev_logged') === 'true') showDash();
        
    </script>
</body>
</html>